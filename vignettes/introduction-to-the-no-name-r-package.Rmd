---
title: "Introduction to the no.name R package"
author: "Claude Nadeau, Maikol Diasparra, Joel Barnes, Deirdre Hennessy, Rochelle Garner"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 5
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Introduction to the no.name R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
  img { width: 100%; height: auto; }
  p { margin-top: 1rem;line-height: 1.5rem; }
  #TOC { width: 100%; }
  blockquote { border-left: 5px solid #902000; border-bottom: 1px solid #efefef; font-weight: normal; width: 100%; margin-left: 0; background: #ffffff; }
</style>

<img src="img/sig-blk-en.svg" style = "max-width: 300px; height: auto; margin-top: 48px; margin-bottom: 24px; border: 0;" alt="logo">

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This R package enables users to build box/compartment models via an Excel workbook. ODE (ordinary differential equation) or CTMC (continuous-time Markov chain) models can be built with either single (ODE, CTMC) or multiple age groups (ODE). This package also provides tools for users to perform sensitivity analsyes/parameter sweeps on their models and to visualize model results.

## Installation
### GitHub

The most recent version of `no.name` is available on GitHub: <a href="https://github.com/barnzilla/no.name" target="_blank">www.github.com/barnzilla/no.name</a>. The `devtools` package allows users to download and install `no.name` directly from GitHub.

```{r warning = FALSE, message = FALSE, eval = FALSE}
devtools::install_github("barnzilla/no.name", upgrade = "never")
library(no.name)
```

### Source package

Users can also download and install the source package using the `install.packages` function from the `utils` package, which comes pre-installed with R.

```{r warning = FALSE, message = FALSE, eval = FALSE}
utils::install.packages(
  pkgs = "https://github.com/barnzilla/r-package-sources/raw/master/no.name_12.04.tar.gz",
  repos = NULL, 
  type = "source"
)
library(no.name)
```

```{r warning = FALSE, message = FALSE, echo = FALSE}
library(no.name)
```

## Model settings
### Set full path to model Excel workbook

```{r}
file.name <- get.path("phac.model.xls")
```

### Define sheet names

```{r}
sheet.names = list(
  initial.conditions = "Initial conditions",
  parms.notime.0d = "Parameters any time any age", 
  parms.0d = "Parameters any age",
  parms.1d = "Parameters by Age",
  parms.2d = "Parameters by Age x Age",
  model.flow ="Model Specs (not lazy)",
  auxiliary.vars = "Intermediate calculations",
  post.processing = "Post Processing"
)
```

## COVID-19 targets
### Set full path to target file 

```{r}
target.file <- get.path("canadian.covid.19.data.xls")
```

### Create target data frame

```{r}
target.df <- as.data.frame(readxl::read_excel(target.file, sheet = "Canadian data"))

# Create a new column from the Deaths columns
target.df$D <- target.df$Deaths
```

### Set targets
#### Example 1: cumIconfirmed and D at days 30-39, 40-49, 50-59, 60-69, 70-75

```{r}
# Interested in cumIconfirmed and D
covid.targets <- list(donnees = target.df[c("time","cumIconfirmed","D")])

# Interested in five time periods: days 30-39, 40-49, 50-59, 60-69, 70-75
covid.targets$time.ranges <- data.frame(lower.bound = 20 +10 * seq(5))
```

#### Example 2: cumIconfirmed at day 75

```{r}
# Interested in cumIconfirmed
covid.targets <- list(donnees = target.df[c("time","cumIconfirmed")])    

# Interested in one time: day 75
covid.targets$time.ranges <- data.frame(lower.bound = 75, upper.bound = 75)
```

#### Example 3: cumIconfirmed at days 47, 88, 175

```{r}
# Interested in cumIconfirmed
covid.targets <- list(donnees = target.df[c("time","cumIconfirmed")])                     

# Interested in three times: days 47, 88, 175
covid.targets$time.ranges <- data.frame(
  lower.bound = c(47, 88, 175),
  upper.bound = c(47, 88, 175)
)  
```

#### Example 4: cumIconfirmed at days 47, 88, 175 for each of 6 age groups

```{r}
# Interested in cumIconfirmed1, cumIconfirmed2, ..., cumIconfirmed6
covid.targets <- list(donnees = target.df[c("time", paste0("cumIconfirmed", 1:6))])         

# Interested in three times: days 47, 88, 175
covid.targets$time.ranges <- data.frame(
  lower.bound = c(47, 88, 175),
  upper.bound = c(47, 88, 175)
)
```

## Sampling specifications

> NOTE: this is the only place where users name the parameters. Use the parameter name as it appears in the relevant Excel spreadsheet.

```{r}
hypercube.specs <- read.hypercube.sampling.specs(
  file.name, 
  sheet = "HyperCube Sampling Specs"
) 

parm.cloud.grid.specs <- list(
  hypercube.lower.bounds = hypercube.specs$lower.bound,
  hypercube.upper.bounds = hypercube.specs$upper.bound,
  hypercube.apex.mode    = hypercube.specs$apex , # To be commented if uniform
  n.repeat.within.hypercube = 4, # 10000, icitte
  LatinHypercubeSampling = c(FALSE, TRUE)[2],
  racine = 123,
  backend.transformation = function(x) {x}, # Need to provide a function like exp here
  reference.alteration = c("overwrite", "add", "multiply")[1],
  tmin.alter.scope = 0:1000
)
```

## Run model

```{r}
results.baseline <- seir.n.age.classes(
  file.name,
  sheet.names,
  functions.kit = list(
    post.processing.companion.kit = list(targets = covid.targets)
  )
)
```

## Parameter sweep
### Examine the specifications

```{r}
str(parm.cloud.grid.specs) 

take.a.quick.look <- try.various.parms.values(
  results.baseline,
  parm.cloud.grid.specs,
  only.show.parms.to.try = TRUE
)

# Check size of the parameter sweep about to be undertaken (e.g., number of scenarios, number of parameters)
dim(take.a.quick.look$parms.to.try)  
```

### Run the parameter sweep

```{r}
various.parms.result <- try.various.parms.values(
  results.baseline,
  parm.cloud.grid.specs
)
```

### Create data structures from various results

```{r}
parms.tried.df <- various.parms.result$parms.to.try
list.sweep <- various.parms.result$list.sweep
df.sweep<- various.parms.result$df.sweep
outcomes.summary.df <- various.parms.result$outcomes.summary.df
```

### Backup results

```{r eval = FALSE}
# This creates a file named "This file contains an R object called list.sweep.SavedFromR". Use load() to load this back into the R global environment.
verbose.save("list.sweep") 
verbose.save("df.sweep")
verbose.save("outcomes.summary.df") 
verbose.save("parms.tried.df")  
```

### Visualize results
#### Scatter plot

```{r}
get.scatter.plot(
   x = outcomes.summary.df$lambda_Period1.overwrite,
   y = outcomes.summary.df$AR,
   x_label_text = "Lambda",
   y_label_text = "AR",
   height = 500,
   width = 756
 )
```

#### Tornado plot

```{r eval = FALSE}
# Render a tornado plot
 get.tornado.plot(
   outcome_variable = "AR",
   parameters = parms.tried.df,
   outcomes = outcomes.summary.df,
   method = "spearman-partial-correlation-slow",
   height = 500,
   width = 756,
   parameter_labels = paste0("parm", 1:15)
 )
```

#### Tornado table

```{r eval = FALSE}
get.tornado.table(
   outcome.variable = "AR",
   parameters = parms.tried.df,
   outcomes = outcomes.summary.df,
   method = "spearman-partial-correlation-slow"
 )
```
