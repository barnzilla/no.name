---
title: "Introduction to the sweepr R package"
author: "Claude Nadeau, Maikol Diasparra, Joel Barnes, Deirdre Hennessy, Rochelle Garner"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Introduction to the sweepr R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
  img { width: 100%; height: auto; }
</style>

<img src="https://www.statcan.gc.ca/wet-boew4b/assets/sig-blk-en.svg" style = "max-width: 300px; height: auto; margin-top: 48px; margin-bottom: 24px; border: 0;" alt="logo">

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installing sweepr
### GitHub

The most recent version of sweepr is available from the following GitHub repository: <a href="https://github.com/barnzilla/sweepr" target="_blank">www.github.com/barnzilla/sweepr</a>. The `devtools` R package allows you to download/install sweepr directly from this repository.

```{r warning = FALSE, message = FALSE, eval = FALSE}
devtools::install_github("barnzilla/sweepr")
```

### Source package

You can also download/install the source package using the `install.packages` function from the `utils` package, which is preinstalled in R.

```{r warning = FALSE, message = FALSE, eval = FALSE}
utils::install.packages("https://github.com/barnzilla/r-package-sources/raw/master/sweepr_0.11.5.tar.gz", repos = NULL, type = "source")
```

## Loading sweepr

```{r warning = FALSE, message = FALSE}
library(sweepr)
```

## Running a parameter sweep
### Defining the model inputs

```{r}
# The filename to an example spreadsheet that comes with the sweepr package
file_name <- paste0(system.file(package = "sweepr"), "/extdata/model-inputs2.xls")

# The sheetnames containing the initial conditions and parameters for the model
sheet_names <- list(
  initial.conditions = "Initial conditions",
  parms.0d = "Parameters any age",
  parms.1d = "Parameters by Age",
  parms.2d = "Parameters by Age x Age",
  model.flow = "Model Specs (not lazy)",
  auxiliary.vars = "Intermediate calculations",
  post.processing="Post Processing"
)
```

### Fitting a baseline model

```{r}
baseline_results <- SEIR.n.Age.Classes(file_name, sheet_names)
```

The `baseline_results` object is a list containing detailed data/results from the baseline model.

```{r}
str(baseline_results)
```

### Defining the specifications

```{r}
hypercube_lower_bounds <- list(
  # 0.3, 0.4, 0.5, 0.6, 0.7, 0.8 (contact tracing)
  lambda = seq(0.3, 0.8, 0.1),
  # 0.3, 0.4, 0.5, 0.6, 0.7, 0.8 (case identification/isolation)
  delta  = seq(0.3, 0.8, 0.1), 
  # 3/6, 4/6, 5/6
  Cgg_fudging_multiplier = (3:5)/6  
)
hypercube_upper_bounds <- hypercube_lower_bounds
```

```{r}
parm_cloud_grid_specs <- list(
  hypercube.lower.bounds = hypercube_lower_bounds,
  hypercube.upper.bounds = hypercube_upper_bounds,
  n.repeat.within.hypercube = 1,
  # TRUE or FALSE
  LatinHypercubeSampling = TRUE,
  # Seed number so results can be reproduced
  racine = 42,
  # Need to provide a function like exp here
  backend.transformation = function(x) {x},
  # Options include "overwrite", "add" and "multiply"
  reference.alteration = "overwrite",
  tmin.alter.scope = 88
)
```

The specifications can be quickly examined using the `str` function.

```{r}
str(parm_cloud_grid_specs)
```

Next, check the size of the parameter sweep (i.e. number of scenarios, number of parameters).

```{r}
sweep_size <- try.various.parms.values(
  baseline_results,
  parm_cloud_grid_specs,
  only.show.parms.to.try = TRUE
)

# Number of scenarios, number of parameters
dim(sweep_size$parms.to.try)
```

### Running the parameter sweep

```{r eval = FALSE}
parameter_sweep_results <- try.various.parms.values(baseline_results, parm_cloud_grid_specs)
```

*Note:* this operation may take a long time to run depending on the size of the parameter sweep and on the computer resources available.

### Saving the results

```{r eval = FALSE}
parameters_swept <- parameter_sweep_results$parms.to.try
sweep_list <- parameter_sweep_results$list.sweep
sweep_df <- parameter_sweep_results$df.sweep
outcomes_summary_df <- parameter_sweep_results$outcomes.summary.df

# Set the path to where you want to save the results
setwd("c:/users/your_username/desktop")

# Creates a file called "This file contains an R object called parameters_swept.SavedFromR".
verbose.save("parameters_swept") 
verbose.save("sweep_list")
verbose.save("sweep_df")
verbose.save("outcomes_summary_df")
```

*Note:* use the `load` function to import these saved objects into your global environment.

```{r eval = FALSE}
load("c:/users/your_username/desktop/This file contains an R object called parameters_swept.SavedFromR")
```

### Visualizing the results

You can render a scatter plot of any two vectors in the `outcomes_summary_df` dataframe.

```{r echo = FALSE}
data("sweepr_demo")
outcomes_summary_df <- outcomes.summary.df <- sweepr_demo$results
parameters_swept <- sweepr_demo$parameters
```

```{r}
get_scatter_plot(outcomes_summary_df$delta.overwrite, outcomes_summary_df$maxInc, height = 500, width = 756)
```
  
<br />
<br />

You can also render a tornado plot of any vector within the `outcomes_summary_df` dataframe.

```{r}
get_tornado_plot(outcome_variable = "maxInc", parameters = parameters_swept, outcomes = outcomes_summary_df, height = 500, width = 756)
```
